<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Linguistic Chatbot</title>
  <link rel="icon" href="https://img.icons8.com/ios-filled/50/robot-2.png" />
  <style>
    body {
      background-color: #f2f2f2;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }

    .chat-container {
      width: 400px;
      max-height: 90vh;
      margin: 50px auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(to right, #007bff, #ffa500);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    .chat-box {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .user {
      text-align: right;
      color: #007bff;
    }

    .bot {
      text-align: left;
      color: #ffa500;
    }

    .input-area {
      display: flex;
      flex-wrap: wrap;
      border-top: 1px solid #ddd;
      padding: 10px;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    input[type="text"] {
      flex: 1 1 200px;
      padding: 10px;
      border: none;
      outline: none;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      min-width: 150px;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      white-space: nowrap;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #0056b3;
    }

    .icon {
      width: 20px;
      vertical-align: middle;
      margin-right: 5px;
    }

    #relatedWordsContainer {
      padding: 10px 20px;
      background: #f0f8ff;
      border-top: 1px solid #ddd;
      max-height: 150px;
      overflow-y: auto;
      overflow-x: hidden;
      font-family: 'Segoe UI', sans-serif;
    }

    #relatedWordsContainer h4 {
      margin-top: 0;
      color: #007bff;
    }

    #relatedResults {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 100%;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .word-pill {
      background-color: #e0f3ff;
      padding: 6px 14px;
      border-radius: 20px;
      color: #007acc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
      white-space: nowrap;
    }

    .word-pill:hover {
      background-color: #b8d9ff;
    }

    #grammarSuggestions {
      background: #fff7e6;
      border: 1px solid #ffa500;
      padding: 10px 20px;
      margin-top: 10px;
      font-family: 'Segoe UI', sans-serif;
      color: #a66100;
      max-height: 150px;
      overflow-y: auto;
      border-radius: 10px;
    }

    #grammarSuggestions h4 {
      margin-top: 0;
      color: #ffa500;
    }

    .suggestion-item {
      margin-bottom: 10px;
    }

    .replacement-list {
      margin: 4px 0 8px 20px;
      color: #007acc;
      cursor: pointer;
    }

    .replacement-list span {
      background-color: #d0e7ff;
      padding: 2px 6px;
      margin-right: 6px;
      border-radius: 8px;
      user-select: none;
      transition: background-color 0.3s;
    }

    .replacement-list span:hover {
      background-color: #a1c6ff;
    }

  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" class="icon" />
      Linguistic Chatbot
    </div>
    <div class="chat-box" id="chat-box">
      <!-- Chat messages will appear here -->
    </div>
    <div class="input-area">
      <input type="text" id="word-input" placeholder="Enter a word..." />
      <button onclick="sendWord()">Send</button>
      <button onclick="startListening()">üé§</button>
      <button onclick="showRelatedWords()">üîç Related Words</button>
    </div>
    <div id="relatedWordsContainer" style="display: none;">
      <h4>Related Words:</h4>
      <div id="relatedResults"></div>
    </div>
    <div id="grammarSuggestions" style="display: none;">
      <h4>Grammar Suggestions:</h4>
      <div id="suggestionsList"></div>
    </div>
  </div>

  <script>
    let history = [];

    function speak(text) {
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      synth.speak(utter);
    }

    function isValidWord(word) {
      return new Promise(resolve => {
        fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`)
          .then(res => res.ok ? resolve(true) : resolve(false))
          .catch(() => resolve(false));
      });
    }

    async function sendWord() {
      const input = document.getElementById("word-input");
      const word = input.value.trim();
      if (!word) return;

      // Hide related & grammar sections initially
      document.getElementById("relatedWordsContainer").style.display = "none";
      document.getElementById("grammarSuggestions").style.display = "none";

      const chatBox = document.getElementById("chat-box");
      const userMsg = document.createElement("div");
      userMsg.className = "message user";
      userMsg.textContent = "You: " + word;
      chatBox.appendChild(userMsg);

      chatBox.scrollTop = chatBox.scrollHeight;
      input.value = "";
      history.push(word);

      if (!await isValidWord(word)) {
        const botMsg = document.createElement("div");
        botMsg.className = "message bot";
        botMsg.innerHTML = `<span style="color: red;">Did you mean: <i>${word}?</i> Please check the spelling.</span>`;
        chatBox.appendChild(botMsg);
        speak("Did you mean " + word + "? Please check the spelling.");
        chatBox.scrollTop = chatBox.scrollHeight;
        return;
      }

      fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ word: word })
      })
      .then(response => response.json())
      .then(data => {
        const botMsg = document.createElement("div");
        botMsg.className = "message bot";

        let responseHTML = "Bot:<br>";
        if (data.pos_info) {
          responseHTML += `<br><span style='color:red; font-weight:bold;'>Parts of Speech:</span><br>`;
          data.pos_info.forEach(p => {
            responseHTML += `<span style='color:orange;'>- ${p.word}: ${p.pos} (${p.tag})</span><br>`;
          });
        }

        if (data.affix_info) {
          responseHTML += `<br><span style='color:red; font-weight:bold;'>Affix Info:</span><br>`;
          data.affix_info.forEach(a => {
            if (a.type === "none") {
              responseHTML += `<span style='color:orange;'>- No prefix/suffix found</span><br>`;
            } else {
              responseHTML += `<span style='color:orange;'>- ${a.type}: ${a.affix}, root: ${a.root_word}</span><br>`;
            }
          });
        }

        botMsg.innerHTML = responseHTML;
        chatBox.appendChild(botMsg);

        // Show grammar suggestions
        if (data.grammar && data.grammar.length > 0) {
          const grammarContainer = document.getElementById("grammarSuggestions");
          const suggestionsList = document.getElementById("suggestionsList");
          suggestionsList.innerHTML = "";

          data.grammar.forEach((g, i) => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerHTML = `<b>Issue:</b> ${g.message}<br/>`;

            if (g.replacements && g.replacements.length > 0) {
              const replDiv = document.createElement("div");
              replDiv.className = "replacement-list";
              replDiv.textContent = "Suggestions: ";

              g.replacements.forEach(rep => {
                const span = document.createElement("span");
                span.textContent = rep;
                // On click, put suggestion into input box for quick correction
                span.onclick = () => {
                  document.getElementById("word-input").value = rep;
                };
                replDiv.appendChild(span);
              });

              div.appendChild(replDiv);
            }

            suggestionsList.appendChild(div);
          });

          grammarContainer.style.display = "block";
        } else {
          document.getElementById("grammarSuggestions").style.display = "none";
        }

        speak(botMsg.textContent);
        chatBox.scrollTop = chatBox.scrollHeight;
      })
      .catch(() => {
        const botMsg = document.createElement("div");
        botMsg.className = "message bot";
        botMsg.textContent = "Error connecting to chatbot.";
        chatBox.appendChild(botMsg);
        speak("Error connecting to chatbot.");
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();
      recognition.onresult = function(event) {
        const word = event.results[0][0].transcript;
        document.getElementById("word-input").value = word;
        sendWord();
      };
    }

    function showRelatedWords() {
      const word = document.getElementById("word-input").value.trim();
      if (!word) return;

      fetch("/related", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ word: word })
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("relatedResults");
        container.innerHTML = "";

        function createWordPill(w) {
          const pill = document.createElement("div");
          pill.textContent = w;
          pill.className = "word-pill";
          pill.onclick = () => {
            document.getElementById("word-input").value = w;
            sendWord();
          };
          return pill;
        }

        if ((data.prefixes.length === 0) && (data.suffixes.length === 0)) {
          container.textContent = "No related words found.";
        } else {
          // Prefix section
          if (data.prefixes.length > 0) {
            const preHeader = document.createElement("h5");
            preHeader.textContent = "Prefixes:";
            preHeader.style.color = "#007bff";
            container.appendChild(preHeader);
            data.prefixes.forEach(w => {
              container.appendChild(createWordPill(w));
            });
          }
          // Suffix section
          if (data.suffixes.length > 0) {
            const sufHeader = document.createElement("h5");
            sufHeader.textContent = "Suffixes:";
            sufHeader.style.color = "#007bff";
            container.appendChild(sufHeader);
            data.suffixes.forEach(w => {
              container.appendChild(createWordPill(w));
            });
          }
        }

        document.getElementById("relatedWordsContainer").style.display = "block";
      });
    }

    document.getElementById("word-input").addEventListener("keydown", function (e) {
      if (e.key === "Enter") sendWord();
    });
  </script>
</body>
</html>
